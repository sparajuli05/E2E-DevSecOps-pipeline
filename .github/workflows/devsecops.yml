# The name of the workflow as it appears in the GitHub Actions 'Actions' tab.
name: Sentinel-Flow-CI

# 'on' defines the events that trigger this pipeline to run.
on:
  # Trigger when code is pushed to the 'main' branch.
  push:
    branches: [ "main" ]
  # Trigger when a developer opens a Pull Request (PR) targeting the 'main' branch.
  pull_request:
    branches: [ "main" ]

# A workflow is made of one or more 'jobs'.
jobs:
  # This job handles building and security checks.
  build-and-secure:
    # 'runs-on' specifies the operating system of the GitHub-hosted virtual machine.
    # 'ubuntu-latest' is the standard, fastest Linux runner.
    runs-on: ubuntu-latest

    # A job consists of a sequence of 'steps'.
    steps:
      # STEP 1: GitHub runners start with an empty directory. 
      # This 'checkout' action downloads your repository code onto the runner.
      - name: Checkout code
        uses: actions/checkout@v4

      # STEP 2: 'Gitleaks' scans the history of your code for hardcoded passwords, 
      # API keys, or tokens. This prevents credentials from being leaked accidentally.
      - name: Secret Scanning (Gitleaks)
        uses: gitleaks/gitleaks-action@v2
        env:
          # A built-in token provided by GitHub to allow the action to comment on PRs.
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
     
     
      #STEP 3. Build the Image using Day02 as the source
      # change this path if you like to use docker file from other location
      - name: Build Docker Image
        run: |
          docker build \
            -t sentinel-app:${{ github.sha }} \
            -f Day01/Dockerfile Day01

      # STEP 3: Create the Docker image using the Dockerfile we hardened in Phase 1.
      # '${{ github.sha }}' is a unique ID for the specific code version being built.
      - name: Build Docker Image
        run: docker build -t sentinel-app:${{ github.sha }} .

      # STEP 4: This is our 'Security Gate'. 
      # Trivy scans the layers of the Docker image for known security flaws (CVEs).
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          # Tells Trivy which specific image to scan.
          image-ref: 'sentinel-app:${{ github.sha }}'
          # Output the results in a readable table format within the GitHub console.
          format: 'table'
          # 'exit-code: 1' means if a threat is found, the build will CRASH (fail).
          # This prevents insecure code from moving forward to deployment.
          exit-code: '1' 
          # We only fail the build for the most dangerous levels of vulnerabilities.
          severity: 'CRITICAL,HIGH'

      # 5. Notify the team of the result
      - name: Send Slack Notification
        if: always() # Runs even if previous steps failed
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
          SLACK_TITLE: 'Sentinel-Flow CI Result'
          SLACK_MESSAGE: 'Build Status: ${{ job.status }}'
          SLACK_COLOR: ${{ job.status == 'success' && 'good' || 'danger' }}